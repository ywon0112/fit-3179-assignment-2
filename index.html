<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIT3179 - Water and Wealth in the MDB</title>
    
    <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.6.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.21.0"></script>
    
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div class="container">
        <h1>The Lifeblood of a Nation</h1>
        <p style="text-align: center; font-size: 1.2rem; color: #495057;">Water and Wealth in the Murray-Darling Basin (2020)</p>
        <p>
            The Murray-Darling Basin is the agricultural heart of Australia, but its water is a finite and precious resource. This visualization explores the fundamental relationship between where water is available (the "Cause"), how it is used (the "Action"), and the economic value it generates (the "Effect"), telling a story of adaptation and production across the basin's diverse regions.
        </p>

        <h2>Explore the Data</h2>
        <p>
            The map below shows the key catchment regions of the basin. The <strong>colour</strong> of each bubble represents the average annual rainfall (mm), while the <strong>size</strong> of the bubble represents the total economic value ($AUD million) of its agricultural production for 2020. Click on a bubble to explore further.
        </p>
        
        <div class="vis-container">
            <div id="map_vis"></div>
        </div>

        <p>
            The charts below show the breakdown for the selected region. The left chart displays the volume of water used (ML) by each major agricultural industry. The right chart displays the gross economic value ($AUD million) generated by each industry.
        </p>

        <div class="vis-container">
            <div id="overview_vis"></div>
            <p>Overview: Each point is a catchment. X = average annual rainfall (mm). Y = total irrigated value ($AUD million). Bubble size = total water use (ML). Selecting a catchment on the map highlights it here.</p>
        </div>
 
        <div class="vis-container vis-row">
            <div class="vis-card"><div id="water_vis"></div></div>
            <div>
                <h2>Water Use by Industry</h2>
                <p>Shows how irrigation water (ML) is distributed across major industries in the selected catchment. Use this to compare water intensity across sectors.</p>
            </div>
        </div>

        <div class="vis-container vis-row">
            <div class="vis-card"><div id="value_vis"></div></div>
            <div>
                <h2>Economic Value by Industry</h2>
                <p>Displays the gross value of irrigated production ($AUD million) by industry for the selected catchment. Contrast this with water use to see efficiency/value creation.</p>
            </div>
        </div>

        <div class="footer">
            <p><strong>Author:</strong> Wong Yie Meng</p>
            <p><strong>Data Source:</strong> ABARES, Murray-Darling Basin water market catchment dataset 2021.</p>
        </div>
    </div>

    <script>
        console.log('Loading visualizations...');
        
        const mapSpec = "js/map_spec.json";
        const overviewSpec = "js/overview_spec.json";
        const waterSpec = "js/water_use_spec.json";
        const valueSpec = "js/value_spec.json";
        let overviewView, waterView, valueView;

        // Embed the map
        vegaEmbed('#map_vis', mapSpec, {actions: false}).then(result => {
            const mapView = result.view;

            // Embed overview, water, and value specs
            Promise.all([
              vegaEmbed('#overview_vis', overviewSpec, {actions: false}),
              vegaEmbed('#water_vis', waterSpec, {actions: false}),
              vegaEmbed('#value_vis', valueSpec, {actions: false})
            ]).then(([o, w, v]) => {
              overviewView = o.view; waterView = w.view; valueView = v.view;

              // Forward map selection to all three views
              mapView.addSignalListener('region_select_tuple', function(name, value) {
                let selectedRegion = null;
                if (value && value.values && value.values.length > 0) {
                  const fields = value.fields || [];
                  let regionIdx = -1;
                  for (let i = 0; i < fields.length; i++) {
                    const f = fields[i];
                    const fname = typeof f === 'object' ? f.field : f;
                    if (fname === 'Region') { regionIdx = i; break; }
                  }
                  const firstVal = value.values[0];
                  const regionVal = Array.isArray(firstVal) ? (regionIdx !== -1 ? firstVal[regionIdx] : firstVal[0]) : firstVal;
                  selectedRegion = (regionVal || '').toString().trim() || null;
                }
                overviewView.signal('selectedRegion', selectedRegion).run();
                waterView.signal('selectedRegion', selectedRegion).run();
                valueView.signal('selectedRegion', selectedRegion).run();
              });
            }).catch(console.error);
        }).catch(console.error);
    </script>
</body>
</html>
