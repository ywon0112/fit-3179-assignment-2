<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIT3179 - Water and Wealth in the MDB</title>
    
    <script src="https://cdn.jsdelivr.net/npm/vega@5.22.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-lite@5.6.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega-embed@6.21.0"></script>
    
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <div class="container">
        <h1>The Lifeblood of a Nation</h1>
        <p style="text-align: center; font-size: 1.2rem; color: #495057;">Water and Wealth in the Murray-Darling Basin (2020)</p>
        <p>
            The Murray-Darling Basin is the agricultural heart of Australia, but its water is a finite and precious resource. This visualization explores the fundamental relationship between where water is available (the "Cause"), how it is used (the "Action"), and the economic value it generates (the "Effect"), telling a story of adaptation and production across the basin's diverse regions.
        </p>

        <h2>Explore the Data</h2>
        <p>
            The map below shows the key catchment regions of the basin. The <strong>colour</strong> of each bubble represents the average annual rainfall (mm), while the <strong>size</strong> of the bubble represents the total economic value ($AUD million) of its agricultural production for 2020. Click on a bubble to explore further.
        </p>
        
        <div class="vis-container">
            <div id="map_vis"></div>
        </div>

        <p>
            The charts below show the breakdown for the selected region. The left chart displays the volume of water used (ML) by each major agricultural industry. The right chart displays the gross economic value ($AUD million) generated by each industry.
        </p>

        <div class="vis-container">
            <div id="charts_vis"></div>
        </div>

        <h2>Key Insights</h2>
        <p>
            The visualization reveals a powerful insight: the most economically valuable regions are not always those with the highest rainfall. By clicking on the large, light-blue bubbles (low rain, high value) like the 'NSW Murrumbidgee' or 'VIC Goulburn-Broken', you can see how extensive use of irrigation for high-value crops like cotton and grapevines drives economic output, highlighting the critical importance of water management in overcoming natural constraints.
        </p>

        <div class="footer">
            <p><strong>Author:</strong> [Your Name]</p>
            <p><strong>Data Source:</strong> ABARES, Murray-Darling Basin water market catchment dataset 2021.</p>
        </div>
    </div>

    <script>
        console.log('Loading visualizations...');
        
        const mapSpec = "js/map_spec.json";
        const chartsSpec = "js/charts_spec.json";

        // Embed the map
        vegaEmbed('#map_vis', mapSpec, {actions: false}).then(result => {
            console.log('Map loaded successfully');
            const mapView = result.view;

            // Embed the charts
            vegaEmbed('#charts_vis', chartsSpec, {actions: false}).then(result2 => {
                console.log('Charts loaded successfully');
                const chartsView = result2.view;

                // Listen to the selection tuple signal which contains the selected data
                mapView.addSignalListener('region_select_tuple', function(name, value) {
                    console.log('Selection tuple changed:', value);
                    
                    if (value && value.values && value.values.length > 0) {
                        let regionIndex = -1;
                        if (value.fields) {
                            for (let i = 0; i < value.fields.length; i++) {
                                const field = value.fields[i];
                                const fieldName = typeof field === 'object' ? field.field : field;
                                if (fieldName === 'Region') {
                                    regionIndex = i;
                                    break;
                                }
                            }
                        }

                        const firstValue = value.values[0];
                        const selectedRegion = Array.isArray(firstValue)
                            ? (regionIndex !== -1 ? firstValue[regionIndex] : firstValue[0])
                            : firstValue;

                        const selectedRegionTrimmed = (selectedRegion || '').toString().trim();
                        console.log('Resolved region:', selectedRegionTrimmed);

                        if (selectedRegionTrimmed) {
                            chartsView.signal('selectedRegion', selectedRegionTrimmed).run();
                            console.log('Charts signal set to:', selectedRegionTrimmed);
                        }
                    } else {
                        console.log('Selection cleared or empty');
                    }
                });
            }).catch(err => {
                console.error('Error loading charts:', err);
            });
        }).catch(err => {
            console.error('Error loading map:', err);
        });
    </script>
</body>
</html>
